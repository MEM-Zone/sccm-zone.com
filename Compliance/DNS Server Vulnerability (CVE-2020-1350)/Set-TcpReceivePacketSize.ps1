<#
.SYNOPSIS
    !! DISCOVERY SCRIPT !!
    Sets TcpReceivePacketSize value.
.DESCRIPTION
    Sets TcpReceivePacketSize value to '0xFF00' and sends a message to a google meet channel.
.NOTES
    Created by Ioan Popovici
.LINK
    https://SCCM.Zone/
.LINK
    https://SCCM.Zone/GIT
.LINK
    https://SCCM.Zone/ISSUES
#>

##*=============================================
##* FUNCTION LISTINGS
##*=============================================
#region FunctionListings

#region New-GHCTextMessage
Function New-GHCTextMessage {
    [CmdletBinding()]
    Param (
        # Text Message
        [Parameter(Mandatory)]
        [string]
        $Message
    )

    Begin {
    }

    Process {
        $TextMessage = @{'text' = $message}
        $TextMessage
    }

    End {
    }
}
#endregion

#region Function Send-GHCWebhookMessage
Function Send-GHCWebhookMessage {
    [CmdletBinding()]
    Param (
        # uri
        [Parameter(Mandatory=$true)]
        [string]
        $URI,
        # Message
        [Parameter(Mandatory)]
        [hashtable]
        $Message
    )

    Begin {
    }

    Process {
        $JSON = ConvertTo-Json $Message -Depth 50
        $JSON

        Invoke-WebRequest -UseBasicParsing -Uri $URI -Method POST -Headers @{"Content-Type" = 'Application/json; charset=UTF-8'} -Body $JSON
    }

    End {
    }
}
#endregion

#endregion
##*=============================================
##* END FUNCTION LISTINGS
##*=============================================

##*=============================================
##* SCRIPT BODY
##*=============================================
#region ScriptBody

## Variable Declaration
[string]$URI = ''
[datetime]$currentDateTime = Get-Date
[string]$envComputerNameFQDN = ([Net.Dns]::GetHostEntry('localhost')).HostName
[psobject]$envOS = Get-WmiObject -Class 'Win32_OperatingSystem' -ErrorAction 'SilentlyContinue'
[string]$envOSName = $envOS.Caption.Trim()
[string]$envOSVersion = $envOS.Version
[string]$Path = 'HKLM:\SYSTEM\CurrentControlSet\Services\DNS\Parameters'
[string]$Name = 'TcpReceivePacketSize'
[string]$Value = '0xFF00'
$LastError = $null

Try {
    [string]$KeyValue = '0x{0:x}' -f $(Get-ItemProperty -Path $Path -ErrorAction 'SilentlyContinue').$Name
    If ($KeyValue -ne $Value) {
        Set-ItemProperty -Path $Path -Name $Name -Value $Value -Type 'DWord' -Force -ErrorAction 'Stop'
        Restart-Service -Name 'DNS' -Force -ErrorAction 'Stop'
    }
}
Catch { $LastError = $Error[0].Exception }
Finally {
    If ($LastError) {
        Write-Output -InputObject $LastError
        $WebhookMessage = New-GHCTextMessage -Message "$currentDateTime - $envComputerNameFQDN - $envOSName ($envOSVersion) - $LastError"
    }
    Else {
        Write-Output -InputObject 'Remediated'
        $WebhookMessage = New-GHCTextMessage -Message "$currentDateTime - $envComputerNameFQDN - $envOSName ($envOSVersion) - Remediated"
    }
    If ($URI) { Send-GHCWebhookMessage -Message $WebhookMessage -URI $URI -ErrorAction 'SilentlyContinue' | Out-Null }
}

#endregion
##*=============================================
##* END SCRIPT BODY
##*=============================================